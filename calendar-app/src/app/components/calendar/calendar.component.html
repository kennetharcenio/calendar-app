<div class="calendar-container" [class.is-dragging]="isDragging()">
  <header class="calendar-header">
    <div class="header-left">
      <h1>Calendar</h1>
      <span class="week-label">{{ currentWeekLabel() }}</span>
    </div>
    <div class="header-controls">
      <button class="btn btn-secondary" (click)="previousWeek()">← Prev</button>
      <button class="btn btn-secondary" (click)="goToToday()">Today</button>
      <button class="btn btn-secondary" (click)="nextWeek()">Next →</button>
      <button class="btn btn-primary" (click)="openEventForm()">+ Add Event</button>
      <app-theme-toggle></app-theme-toggle>
    </div>
  </header>

  <!-- Day headers (fixed, not scrolling) -->
  <div class="week-header">
    <div class="time-column-spacer"></div>
    <div class="day-headers-grid">
      @for (day of weekDays(); track day.dateString) {
        <div class="day-header" [class.today]="day.isToday">
          <span class="day-name">{{ day.dayName }}</span>
          <span class="day-date" [class.today-date]="day.isToday">{{ day.date.getDate() }}</span>
        </div>
      }
    </div>
    <div class="scrollbar-spacer"></div>
  </div>

  <!-- Scrollable time grid -->
  <div class="week-view-body">
    <!-- Time labels column -->
    <div class="time-column">
      @for (hour of hours; track hour) {
        <div class="time-slot-label">
          {{ formatHour(hour) }}
        </div>
      }
    </div>

    <!-- Days grid -->
    <div class="days-grid">
      @for (day of weekDays(); track day.dateString; let dayIndex = $index) {
        <div
          class="day-column-body"
          [class.today]="day.isToday"
          (dblclick)="openEventForm(day.dateString)"
          (mousedown)="onGridMouseDown($event, dayIndex)"
          (mousemove)="onGridMouseMove($event, dayIndex)">
          <!-- Hour grid lines -->
          @for (hour of hours; track hour) {
            <div class="hour-line" [style.top.px]="hour * 60"></div>
          }

          <!-- Positioned events -->
          @for (posEvent of getPositionedEventsForDate(day.dateString); track posEvent.event.id) {
            <div
              class="positioned-event"
              [class.dragging]="draggedEventId() === posEvent.event.id"
              [style.top.px]="posEvent.top"
              [style.height.px]="posEvent.height"
              [style.left.%]="posEvent.left"
              [style.width.%]="posEvent.width"
              (mousedown)="onEventMouseDown($event, posEvent.event.id, dayIndex)">
              <div class="event-title">{{ posEvent.event.title }}</div>
              @if (posEvent.height > 30) {
                <div class="event-time">{{ formatTime(posEvent.event.startTime) }}</div>
              }
              <button class="event-delete-btn" (click)="onDeleteEvent(posEvent.event.id); $event.stopPropagation()">×</button>
            </div>
          }

          <!-- Drag preview -->
          @if (isDragging() && dragColumnIndex() === dayIndex) {
            <div
              class="drag-preview"
              [style.top.px]="dragPreviewTop()"
              [style.height.px]="dragPreviewHeight()">
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>

<footer class="app-footer">Built by Kenneth Audrey Arcenio</footer>

@if (showEventForm()) {
  <app-event-form
    [preselectedDate]="selectedDate()"
    (save)="onEventSaved()"
    (cancel)="closeEventForm()">
  </app-event-form>
}
